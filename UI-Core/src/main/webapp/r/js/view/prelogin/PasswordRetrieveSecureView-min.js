/*! PasswordRetrieveSecureView */
define(["jquery","underscore","backbone","text!tpl/prelogin/password_retrieve_secure.html"],function(c,a,e,b){var d=e.View.extend({el:"#body_container",template:a.template(b),initialize:function(){var f=this;c("#sideNav_privacy_policy").siblings().removeAttr("class");this.$el.off().on("submit","form[name=sendpasswd]",function(g){g.preventDefault();getSecretPair(a.bind(f.submitAnswer,f))})},render:function(){var g=this;var f=AMA.config.apiHostUrl+"/accounts/passwordReset/validate?"+c.param({devId:AMA.config.devId});this.$el.html(this.template);c("form[name=sendpasswd]").attr("action",f);this.$el.find("#securityquestion").text(this.options.securityQuestion);return this},events:{"click #submitSecurityAnswer":"btn_submit"},btn_submit:function(f){f.preventDefault();if(checkSecurityAnswer(document.sendpasswd)){this.$el.find("form").submit()}},submitAnswer:function(g){if(typeof g!=="object"){g=JSON.parse(this.responseText)}if(!g){return}var l={secretHandle:g.handle,uniqueToken:this.options.uniqueToken};var i=CryptoJS.enc.Hex.parse(g.secretKey);var f=CryptoJS.enc.Hex.parse(g.initVector);var k=this.$el.find("[name=securityanswer]").val();var m=CryptoJS.AES.encrypt(k,i,{iv:f});var h=this.$el.find("form[name=sendpasswd]").attr("action");l.securityAnswer=m.toString();setCookie("u_token",l.uniqueToken,1);AMA.debug("Sending AJAX request: "+h);var j=createCORSRequest.call(this,"POST",h);if(j){j.setRequestHeader("Content-type","application/json");j.onerror=function(o,n,p){AMA.debug("AJAX Request to "+h+" returns "+j.status);c("#wronganswer").show()};j.onreadystatechange=function(){if(j.readyState===4&&j.status===200){window.location="#password_reset"}};j.send(JSON.stringify(l))}}});return d});