/*! PasswordResetView */
define(["jquery","underscore","backbone","text!tpl/prelogin/password_reset.html"],function(c,a,e,b){var d=e.View.extend({el:"#body_container",template:a.template(b),initialize:function(){var f=this;c("#sideNav_privacy_policy").siblings().removeAttr("class");this.$el.off().on("submit","form[name=updateAccountPassword]",function(g){g.preventDefault();getSecretPair(a.bind(f.createNewPassword,f))})},render:function(){var g=this;var f=AMA.config.apiHostUrl+"/accounts/passwordReset/change?"+c.param({devId:AMA.config.devId});this.$el.html(this.template);c("form[name=updateAccountPassword]").attr("action",f);return this},events:{"click #resetPasswordBtn":"btn_submit"},btn_submit:function(h){var i=c.trim(this.$el.find("[name=newpin1]").val()),f=c.trim(this.$el.find("[name=confirmpin1]").val()),g=/^\s*[a-zA-Z0-9,\s]+\s*$/;if(i.length<6||i.length>15){AMA.Util.switchLabel(".validation_text",".password_length",this.$el.find(".validation_pinInfo"));return false}if(i.length>0&&!g.test(i)){AMA.Util.switchLabel(".validation_text",".special_chars",this.$el.find(".validation_pinInfo"));return false}if(i!==f){AMA.Util.switchLabel(".validation_text",".not_match",this.$el.find(".validation_pinInfo"));return false}this.$el.find("form").submit()},createNewPassword:function(h){if(typeof h!=="object"){h=JSON.parse(this.responseText)}if(!h){return}var o=getCookie("u_token");var k={secretHandle:h.handle,uniqueToken:o};var m=CryptoJS.enc.Hex.parse(h.secretKey);var g=CryptoJS.enc.Hex.parse(h.initVector);var l=this.$el.find("[name=newpin1]").val();var j=this.$el.find("[name=confirmpin1]").val();var n=CryptoJS.AES.encrypt(l,m,{iv:g});var p=CryptoJS.AES.encrypt(j,m,{iv:g});var f=this.$el.find("form[name=updateAccountPassword]").attr("action");k.newPassword=n.toString();k.confirmPassword=p.toString();AMA.debug("Sending AJAX request: "+f);var i=createCORSRequest.call(this,"POST",f);if(i){i.setRequestHeader("Content-type","application/json");i.onerror=function(r,q,s){AMA.ActionManager._onAjaxError(r,q,s);window.location="#password_reset_failed"};i.onreadystatechange=function(){if(i.readyState===4&&i.status===200){window.location="#password_reset_successful"}};i.send(JSON.stringify(k))}}});return d});