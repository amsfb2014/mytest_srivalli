/*! SecurePhoneDialog */
(function(){AMA.namespace("view");var a=AMA.view.SecurePhoneDialog=AMA.view.Wizard.extend();a.TEMPLATE_ID="securephone_dialog_template";a.TEMPLATE_SRC="";_.extend(a.prototype,{initialize:function(){a.__super__.initialize.apply(this);this._performAnnounce=false;this._performErase=false;this._locateSuccess=false;this._wipeSuccess=false;this._announceSuccess=false},events:{"click .close":"hide","click .btn_cancel":"hide","click .btn_submit":"_doSecurePhone","click #securephone_announce":"_toggleAnnounceTextarea"},_setupEvents:function(){this._setupSteps();var b=this;this.$el.find("#securephone_announce_message").on("keyup",function(){b.$el.find("#securephone_announce_charcount").html(b._countAnnounceTextareaChars())})},show:function(b){a.__super__.show.call(this);this.processDialogView(b);$("#securephone_announce_message").val($("#securephone_announce_default_message").html())},_doSecurePhone:function(){var b=AMA.ActionManager,d=AMA.workflow.BaseWorkflow,f=AMA.workflow.SecurePhoneWorkflow,e=null,c="gpsrefresh",h=this.parent.workflow,g=this;this._performAnnounce=$("#securephone_announce").is(":checked");this._performErase=$("#securephone_wipe").is(":checked");e=this._performAnnounce?$.trim(this.$el.find("#securephone_announce_message").val()):null;if(this._performAnnounce&&e.length==0){this.$el.find(".error").addClass("hidden");this.$el.find(".error.notext").removeClass("hidden");return}c+=this._performErase?"|wipe":"";c+=this._performAnnounce?"|announce":"";h.on(d.EVENT.STATE_CHANGED,function(i){switch(i.state){case d.STATE.INITIALIZING:AMA.debug("Secure Phone Toolset has switched the Secure Phone Button state to 'connecting'");this.parent.toggleDisplay(AMA.view.SecurePhoneToolset.CSS.CONNECTING);this.processDialogView("step2",i.state);break;case f.STATE.CONNECTING:AMA.debug("Secure Phone Toolset has switched the Secure Phone Button state to 'announcing'; countdown initialized");this.parent.toggleDisplay(AMA.view.SecurePhoneToolset.CSS.ANNOUNCING);this.processDialogView("step2",i.state);break;case f.STATE.ANNOUNCE_DISPLAYED:AMA.debug("Announce message has been viewed on the device by the user; proceeding to next action");this.processDialogView("step2",i.state);break;case f.STATE.CONTACTS_ERASED:AMA.debug("Contacts successfully erased; proceeding to next action");this.processDialogView("step2",i.state,null,null,null,i.contactsErased);break;case f.STATE.REFINING:AMA.debug("Contacts successfully erased; proceeding to next action");AMA.page.content.locationTab.locationMap.CurrentState=AMA.workflow.LocateWorkflow.STATE.REFINING;this.processDialogView("step2",i.state);break;case f.STATE.RETRYING:AMA.debug("Updating the Secure Phone dialog with retry information");this.parent.toggleDisplay(AMA.view.SecurePhoneToolset.CSS.RETRYING);this.processDialogView("step2",i.state,null,null,null,null,i.retryInformation);break;case d.STATE.FINALIZING:AMA.page.content.locationTab.locationMap.CurrentState=d.STATE.FINALIZING;this._locateSuccess=i.locateSuccess;this._wipeSuccess=i.wipeSuccess;this._announceSuccess=i.announceSuccess;break;default:}},this);h.on(d.EVENT.FINISHED,function(i){this.parent.toggleDisplay(AMA.view.SecurePhoneToolset.CSS.NORMAL);switch(i.result){case d.RESULT.SUCCESSFUL:this.processDialogView("step2",i.result,this._locateSuccess,this._wipeSuccess,this._announceSuccess);break;default:AMA.page.content.locationTab.locationMap.status="fail";this.processDialogView("step2",i.result)}},this);h.on(d.EVENT.COUNTDOWN_TICK,function(i){$(".securephone_toolset_countdown").html(i.remaining)},this);$.webpurify.check(e,function(i){if(i){g.$el.find(".error").addClass("hidden");g.$el.find(".error.containsprofanity").removeClass("hidden");return}else{g.parent.start({actionsString:c,announceMessage:e,performAnnounce:g._performAnnounce,performErase:g._performErase})}})},processDialogView:function(d,b,i,k,m,e,c){var o=this.$el;var l=(this.options.endpoint.models[0].get("announceSupported")===true);if(d){o.find(".wiz_step").removeClass("current");o.find("."+d+".wiz_step").addClass("current")}if(o.find(".step1").hasClass("current")){o.find(".title .securephone_retry").addClass("hidden");o.find(".step1 .announce, .step1 .wipe, .modal-footer").show();o.find("#securephone_announce").prop("checked",null);o.find("#securephone_wipe").prop("checked",null);if(!l){o.find("#securephone_announce").prop("disabled",true)}o.find(".error").addClass("hidden");this._toggleAnnounceTextarea()}else{if(o.find(".step2").hasClass("current")){var g=AMA.workflow.BaseWorkflow,h=AMA.workflow.SecurePhoneWorkflow,j=o.find("#securephone_announce").prop("checked"),f=o.find("#securephone_wipe").prop("checked");o.find(".announce.feature, .wipe.feature, .divider-announce, .divider-wipe, .modal-footer").hide();if(j){o.find(".announce.feature, .divider-announce").show()}if(f){o.find(".wipe.feature, .divider-wipe").show()}switch(b){case g.STATE.INITIALIZING:o.find(".countdown_text, .waiting").removeClass("hidden");o.find(".countdowndivider").hide();o.find(".success, .fail").addClass("hidden");break;case h.STATE.CONNECTING:o.find(".status.alarm").addClass("hidden");o.find(".status.alarm.success").removeClass("hidden");break;case h.STATE.ANNOUNCE_DISPLAYED:o.find(".status.announce").addClass("hidden");o.find(".status.announce.success").removeClass("hidden");break;case h.STATE.CONTACTS_ERASED:o.find(".status.wipe").addClass("hidden");o.find(".status.wipe.success").removeClass("hidden");o.find(".status.wipe.success .contact_count").html(e);break;case h.STATE.REFINING:o.find(".status.locate").addClass("hidden");o.find(".status.locate.success").removeClass("hidden");break;case h.STATE.RETRYING:o.find(".title .securephone_retry").removeClass("hidden");$(".securephone_retry_current").html(c.retryAttempt);$(".securephone_retry_total").html(c.retryTotal);break;case g.RESULT.SUCCESSFUL:o.find(".title .securephone_retry,.countdown_text,.description,.status.locate,.status.announce,.status.wipe").addClass("hidden");o.find(".securephone_toolset_countdown").html("");o.find(".countdowndivider").show();o.find(".description.success").removeClass("hidden");var n=!i?"fail":"success";o.find(".status.locate."+n).removeClass("hidden");n=this._performAnnounce&&!k?"fail":"success";o.find(".status.announce."+n).removeClass("hidden");n=this._performErase&&!m?"fail":"success";o.find(".status.wipe."+n).removeClass("hidden");AMA.page.content.locationTab.locationMap.render();break;case g.RESULT.FAILED:o.find(".title .securephone_retry,.countdown_text,.description,.status").addClass("hidden");o.find(".description.fail, .status.fail").removeClass("hidden");o.find(".securephone_toolset_countdown").html("");o.find(".countdowndivider").show();AMA.page.content.locationTab.locationMap.render();break;default:}}}},_toggleAnnounceTextarea:function(){var f=this.$el.find("#securephone_announce_message");var e=this.$el.find(".announce_edit,#securephone_announce_message,.charcounttext");if(this.$el.find("#securephone_announce").prop("checked")){var d=AMA.models.dashboardData.models[0].attributes.emailAddress;var c="";if(AMA.models.dashboardData&&!d){var b=f.html();c=f.html()+" "+d+".";f.val(c)}e.removeClass("hidden");f.prop("disabled",null);this.$el.find("#securephone_announce_charcount").html(this._countAnnounceTextareaChars())}else{e.addClass("hidden");f.prop("disabled",true);f.html($("#securephone_announce_default_message").html())}},_countAnnounceTextareaChars:function(){return this.$el.find("#securephone_announce_message").val().length}})})();