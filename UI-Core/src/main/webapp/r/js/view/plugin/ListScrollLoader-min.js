/*! ListScrollLoader */
(function(){AMA.namespace("view.plugin");var a=30;AMA.view.plugin.ListScrollLoader={__name__:"ListScrollLoader",__onPlug__:function(b){AMA.assert(this._selectItem!=null,"ListScrollLoader plug-in is attached to a non-ListView object");this.options.pageSize=this.data&&this.data.pageSize||a;this.options.scrollContainer=b&&b.scrollContainer;this.options.listItemType=b&&b.listItemType;this.options.listItemClassname=b&&b.listItemClassname;this.currentPage=1;this.pageCount=0;this._nonPaginatedDataset=this.data&&this.data.toJSON()||[];this._mustResetPagination=true;AMA.debug("ListScrollLoader plug-in has been plugged into "+this.options.el);if(this.options.scrollContainer){AMA.debug("Linking the ListScrollLoader plug-in to scrollable element "+this.options.scrollContainer);$(this.options.scrollContainer).on("scroll",_.bind(this._onContainerScroll,this));$(window).on("scroll",_.bind(this._onContainerScroll,this));this.on(AMA.view.ListView.EVENT.NEW_DATA_LOADED,_.bind(this._onContainerScroll,this))}this.on(AMA.view.ListView.EVENT.FILTER_ADDED,this._onFilterChange);this.on(AMA.view.ListView.EVENT.FILTER_REMOVED,this._onFilterChange)},_onFilterChange:function(b){if(b.which!=="pagination"){this._mustResetPagination=true}},_beforeRender:function(){this.__beforePlug__.ListScrollLoader._beforeRender.apply(this,arguments);if(this._mustResetPagination){this._addPageFilter(1);this._mustResetPagination=false}},_afterRender:function(){this.__beforePlug__.ListScrollLoader._afterRender.apply(this,arguments);this._nonPaginatedDataset=this._datasetBefore.pagination||[];this.setPageCount();if(this.options.scrollContainer){this._renderListScrollLoader();$(this.options.scrollContainer).scrollTop(0)}},setPageCount:function(){this.pageCount=Math.ceil(this._nonPaginatedDataset.length/this.options.pageSize)},toPage:function(b){if(this.pageCount===0){return}if(b>this.pageCount){b=this.pageCount}AMA.debug(this.options.el+" is switching to page "+b+" of "+this.pageCount);this._addPageFilter(b);this._applyFilters();var c="",d=this.$el.children(":not(.load-marker)").length;_.each(this._dataset,function(f,e){e=e+d;c+=_.template(this.template,this._processData(f,e))},this);this.$loadMarker.before(c);this._setupEvents();this.setPageCount();this.removeFilter("pagination")},_addPageFilter:function(c){var b=this._getPageRange(c);this.addFilter("pagination",function(e,d){return d>=b.first&&d<=b.last},4);this.currentPage=c},_getPageRange:function(c){var b={first:(c-1)*this.options.pageSize,last:c*this.options.pageSize-1};if(!this._mustResetPagination){b.last=Math.min(b.last,this._nonPaginatedDataset.length-1)}return b},_renderListScrollLoader:function(){AMA.debug("Rendering scroll loader of "+this.options.scrollContainer);var b="",c=this.options.listItemType,d=this.options.listItemClassname;b+="<"+c+" class='"+d+" load-marker loading'><span class='progressing'></span></"+c+">";if(this.pageCount>1){this.$el.append(b);this.$loadMarker=$(".load-marker",this.$el)}},_onContainerScroll:function(){if(this.$loadMarker&&this.$loadMarker.is(":visible")){var c=this.$loadMarker[0].getBoundingClientRect(),b=$(this.options.scrollContainer)[0].getBoundingClientRect(),d=(c.top>=0&&c.left>=0&&c.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&c.right<=(window.innerWidth||document.documentElement.clientWidth)&&c.bottom<=b.bottom);if(d){this._loadNextPage()}}},_loadNextPage:function(){if(this.currentPage<this.pageCount){this.toPage(this.currentPage+1)}if(this.currentPage==this.pageCount){this.$loadMarker.hide()}},}})();