/*! SurveyDialog */
(function(){AMA.namespace("view");var a=AMA.view.SurveyDialog=AMA.view.Modal.extend();a.TEMPLATE_ID="survey_dialog_template";a.TEMPLATE_SRC="";a.ENDPOINT="surveyQuestions";a.COOKIE_EXPIRY=3650;a.SESSION_ID=AMA.Util.guid();a.SYNC_EVENT_TYPES=["sync-manual-success","auto-sync-opt-out"];_.extend(a.prototype,{events:{"click #survey_close ":"hideSurvey","click #close":"hideSurvey","click .submit":"_submit","click .cancel":"_cancel","keyup #survey_text_textarea":"_checkCommentLength","click #survey_stars .ratingdiv span":"_setRatingValue"},show:function(b){if(!b){AMA.error("Survey: No survey type specified. Operation will be aborted.");return}else{this._surveyType=b;AMA.debug("Survey: Showing survey dialog of type: "+this._surveyType);$("#survey_step1").show();$("#survey_send_feedback").show();$("#survey_step2").hide();$("#sv_text_close_div").hide();this._fetchSurveyData()}},_fetchSurveyData:function(){if(!AMA.models.capabilities.canRead("surveyQuestions")){AMA.error("Survey: Account has no capability to retrieve survey questions");return}var b=AMA.config.apiHostUrl+"/"+a.ENDPOINT+"?"+$.param({devId:AMA.config.devId,endpointId:AMA.config.endpointId,authToken:AMA.config.authToken,surveyEvent:this._surveyType}),c=AMA.Util.createCORSRequest("GET",b),d=this;if(c){c.onload=function(){try{var f=JSON.parse(this.responseText)}catch(g){AMA.error("Survey: Response not JSON")}if(f){d._init(f)}};c.onerror=function(f,e,g){AMA.ActionManager._onAjaxError(f,e,g)};AMA.debug("Survey: Fetching survey of type: "+this._surveyType);c.send()}},_init:function(c){if(this._surveyType!=c.event){AMA.error("Survey: Response is not the expected for type "+this._surveyType);return}else{if($.inArray(this._surveyType,a.SYNC_EVENT_TYPES)>=0){this._promptSurvey(c)}else{var h=this._surveyType==="location-success"?"Locate":"HealthScan",d="firstTrigger"+h,b="counterOfSuccessful"+h,f=this._isCookieExisting("firstTrigger"+h),j=c.triggerConditionFirst,g=1,e=c.triggerConditionValue,i=parseInt(AMA.Util.getCookie(b));if(f){AMA.debug("Survey: Updating cookies for survey type: "+this._surveyType);j=parseInt(AMA.Util.getCookie(d));g=parseInt(AMA.Util.getCookie(b))+1}else{AMA.debug("Survey: Creating new cookies for survey type: "+this._surveyType);AMA.Util.setCookie(d,j,a.COOKIE_EXPIRY)}AMA.Util.setCookie(b,g,a.COOKIE_EXPIRY);if(!j&&!e){if(i>j){j=parseInt(AMA.Util.getCookie(d))+e;AMA.Util.setCookie(d,j,a.COOKIE_EXPIRY)}}if(g===j){AMA.debug("Survey: Validated trigger values. Launching the survey.");this._promptSurvey(c)}else{return false}}}},_promptSurvey:function(c){var e=false,b=false,f={};if(c&&!c.failures&&c.id){AMA.debug("Survey: Building survey id="+c.id);this._surveyId=c.id;this._questionList=c.questions;this._rating=null;$("#survey_stars").hide();$("#survey_text").hide();for(var d in this._questionList){switch(this._questionList[d].type){case"stars":this.$el.find("#survey_stars_rating1").removeClass("starratingselected").addClass("starrating");this.$el.find("#survey_stars_rating2").removeClass("starratingselected").addClass("starrating");this.$el.find("#survey_stars_rating3").removeClass("starratingselected").addClass("starrating");this.$el.find("#survey_stars_rating4").removeClass("starratingselected").addClass("starrating");this.$el.find("#survey_stars_rating5").removeClass("starratingselected").addClass("starrating");$("#survey_stars").show();$("#survey_stars .survey_error").hide();this.$el.find("#survey_stars .surveyquestion").html(this._questionList[d].label);break;case"text":$("#survey_text").show();$("#survey_text .survey_error").hide();this._textQuestionMinLength=this._questionList[d].minLength||1024;this._textQuestionMaxLength=this._questionList[d].maxLength||1024;this.$el.find("#survey_text .surveyquestion").html(this._questionList[d].label);break;case"appRating":e=true;this._appRatingUrl=this._questionList[d].label;break;default:}}if(this._getDismissSurvey("dismissSurvey")=="true"){b=true}if(e&&!b){this.parent.openAppRating(this._surveyId,this._appRatingUrl)}else{AMA.debug("Survey: Popup ready");f={surveyId:this._surveyId,sessionId:AMA.config.sessionId,endpointId:AMA.config.endpointId,webUserExperienceSurveySessionId:a.SESSION_ID,timestamp:new Date().getTime().toString()};AMA.debug("Survey-Reporting: Survey prompt to user, logging the reporting event.");AMA.ReportingManager.reportEvent(AMA.config.reportingEventTypes.webuserexperiencesurveyprompt,f)}}if(!e){a.__super__.show.apply(this,arguments)}},_getDismissSurvey:function(c){var e=document.cookie.split("; ");for(var b=0;b<e.length;b++){var d=e[b].split("=");if(d[0]===c){return d[1]}}return null},_setRatingValue:function(c){var d=c.target||c.srcElement,b=d.id.split("survey_stars_rating")[1];this._rating=b;this.$el.find("#survey_stars .starratingselected").removeClass("starratingselected").addClass("starrating");switch(b){case"5":this.$el.find("#survey_stars_rating5").removeClass("starrating").addClass("starratingselected");case"4":this.$el.find("#survey_stars_rating4").removeClass("starrating").addClass("starratingselected");case"3":this.$el.find("#survey_stars_rating3").removeClass("starrating").addClass("starratingselected");case"2":this.$el.find("#survey_stars_rating2").removeClass("starrating").addClass("starratingselected");case"1":this.$el.find("#survey_stars_rating1").removeClass("starrating").addClass("starratingselected");default:}},hideSurvey:function(){if(!this._isSubmitted){var b={surveyId:this._surveyId,sessionId:AMA.config.sessionId,endpointId:AMA.config.endpointId,webUserExperienceSurveySessionId:a.SESSION_ID,timestamp:new Date().getTime().toString()};AMA.debug("Survey-Reporting:  User canceled Survey, logging the reporting event."+this._surveyType);AMA.ReportingManager.reportEvent(AMA.config.reportingEventTypes.webuserexperiencesurveycancel,b)}this._isSubmitted=false;this.hide()},_cancel:function(){if(this._surveyId==10||this._surveyId==11){AMA.Util.setCookie("dismissSurvey",true,a.COOKIE_EXPIRY)}this.hideSurvey()},_submit:function(){if(!this._questionList){AMA.error("Survey: Cannot process submission as there is no question list");return}var f=false,c={},b={},e={},g=this;for(var d in this._questionList){c=this._questionList[d];switch(c.type){case"stars":if(c.required&&!this._rating){AMA.error("Survey: Rating required but none provided");f=true;$("#survey_stars .survey_error").show()}else{b[d]=this._rating}break;case"text":this._reason=$("#survey_text_textarea").val();if(c.required&&this._reason.length==0){AMA.error(" Survey: Comment required but none provided");$("#survey_text .survey_error_no_comment").show();f=true}else{if(c.required&&this._reason.length==0){if(this._reason.length<parseInt(c.minLength)){AMA.error("Survey: Comment length is short of minimum required.");$("#survey_text .survey_error_no_comment").show();$("#survey_text .survey_error_min_length").show();$("#survey_text .survey_text_min_chars").html(c.minLength);$("#survey_text .survey_text_min_chars").show()}else{b[d]=this._reason}}else{b[d]=this._reason}}break}}if(!f){AMA.debug("Survey: Response validation passed");if(this._surveyId==10||this._surveyId==11){AMA.Util.setCookie("dismissSurvey",true,a.COOKIE_EXPIRY)}if(AMA.models.capabilities.canCreate("reportEvents")){e={surveyId:this._surveyId,mdn:AMA.models.endpoints.toJSON()[0].name,webUserExperienceSurveySessionId:a.SESSION_ID,responses:b,timestamp:new Date().getTime().toString()};AMA.debug("Survey: Submitting survey responses");AMA.ReportingManager.reportEvent(AMA.config.reportingEventTypes.webuserexperiencesurveysubmit,e,g._confirmSubmission);this._isSubmitted=true}else{AMA.error("Survey: Account does not have permission to submit survey responses");return}}return false},_confirmSubmission:function(b){if(b){$("#survey_step1").hide();$("#survey_send_feedback").hide();$("#survey_step2").show();$("#sv_text_close_div").show()}else{this.hide()}},_isCookieExisting:function(f){var e=document.cookie,c=false,b=null;for(var d=0;d<(e.length-f.length);d++){b=e.substr(d,f.length);if(b===f){c=true;break}}return c},_checkCommentLength:function(){var b=this.$el.find("#survey_text_textarea"),c=b.val().length;if(c>this._textQuestionMaxLength){b.val(b.val().substr(this._textQuestionMinLength,this._textQuestionMaxLength))}}})})();