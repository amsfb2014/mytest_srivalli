/*! LocationSettingsView */
(function(){AMA.namespace("view");var a=AMA.view.LocationSettingsView=AMA.view.BaseView.extend();a.TEMPLATE_ID="location_settings_template";a.TEMPLATE_SRC="";AMA.augment(a.prototype,{_processData:function(b){var c={};c.locationCheck={"true":"","false":""};c.frequencyMinutes={"1":"","3":"","6":""};c.batteryLevelThreshold={"10":"","20":"","30":"","40":"","50":"","60":""};c.locationCheck[(b.locationEnabled)?"true":"false"]="selected='selected'";c.frequencyMinutes[b.frequencyMinutes]="selected='selected'";c.batteryLevelThreshold[b.batteryLevelThreshold]="selected='selected'";return c},render:function(){a.__super__.render.apply(this,arguments)},_afterRender:function(){var b=this.$el.find("select[name=location_check]");a.__super__._afterRender.apply(this,arguments);this.parent.hideElements();this.changeLocationChecks(b.val());if(AMA.models.capabilities.canUpdate("eventSettings")){$("#locations_submit").removeClass("hide")}else{this.$el.find(".location_check").addClass("hide");this.$el.find(".frequencyMin").addClass("hide");this.$el.find(".battery_level").addClass("hide");this.$el.find(".locationbatterynote").addClass("hide");$("#locations_submit").addClass("hide");this.$el.find(".location_check_"+this.$el.find("select[name=location_check]").val()).removeClass("hidden").addClass("readonly");if(this.$el.find("select[name=location_check]").val()==="true"){this.$el.find(".frequency_"+this.$el.find("select[name=frequency]").val()).removeClass("hidden").addClass("readonly")}else{this.$el.find(".frequency").addClass("hide")}this.$el.find(".settings_note").show()}},_setupEvents:function(){var c=this,b=this.$el.find("select[name=location_check]");b.on("change",function(){c.changeLocationChecks(this.value)})},changeLocationChecks:function(h){var c=this.$el.find("select[name=frequency]"),g=c.get(0),e,f=this.$el.find("select[name=battery_level]"),b=f.get(0),d;if(h==="false"){c.find("option").attr("selected",null);c.attr("disabled","disabled");f.find("option").attr("selected",null);f.attr("disabled","disabled")}else{e=""+this.data.models[0].get("frequencyMinutes");c.attr("disabled",null);if(e){c.selectedIndex=this.setSelectedIndex(c,e)}d=this.data.models[0].get("batteryLevelThreshold");f.attr("disabled",null);if(d){f.selectedIndex=this.setSelectedIndex(f,d)}AMA.debug("changeLocationChecks, locationFrequencyValue: "+e+", locationBatteryLevelValue: "+d)}},setSelectedIndex:function(d,e){var b=d.find("option"),c=0;_.each(b,function(g,f){if(g.value===e){c=f;$(g).attr("selected","selected")}});return c},events:{"click .btnLocationSave":"saveLocation"},saveLocation:function(){var b="locations";this.save(b)},save:function(g){$(".settings_intro .intro_after_save_message").html("");var e="";var d={};var h={};var f=[];if($(".settings_content .location_settings").is(":visible")){var b=this.saveLocationSettings(".settings_content");$.extend(h,b.profileData);$.extend(d,b.changes);var c=b.settingsChanged;e=b.hasErrors}if(e){return}if(!c){AMA.Util.switchLabel(".validation_text",".noChanges",this.$el);this.$el.find(".after_save_message").removeClass("hidden");return}$("#"+g+"_submit .connecting").show();var i=this.afterBackupSettingsSave;this.saveSettings(h,c,i.bind(this,h,d,g))},saveLocationSettings:function(b){var e="",c="",d="",g=this.data.models[0];AMA.debug("Location Settings Save data:"+JSON.stringify(g));if(g){e=""+g.get("locationEnabled");c=""+g.get("frequencyMinutes");d=g.get("batteryLevelThreshold")}var h=false;var i={};var f={};f.locationCheck=$(b+" select[name='location_check'] option:selected").val();if(f.locationCheck!==e){h=true;AMA.debug("Location Settings Save - Change made to Location Check Changed... Saving to history")}if(f.locationCheck==="true"){f.frequency=$.trim($(b+" select[name='frequency'] option:selected").val());AMA.debug("Location Settings Save - Frequency: "+f.frequency);if(c!==f.frequency){h=true;AMA.debug("Location Settings Save - Change made to Frequency... Saving to history")}if($(b+" .battery_level").css("display")!=="none"){f.batteryLevel=$.trim($(b+" select[name='battery_level'] option:selected").val());AMA.debug("Location Settings Save - Battery Level: "+f.batteryLevel);if(d!==f.batteryLevel){h=true;AMA.debug("Location Settings Save - Change made to Battery Level... Saving to history")}}}var k=false;if(f.locationCheck==="true"){if(f.frequency===""&&f.batteryLevel===""){AMA.Util.switchLabel(".validation_text",".noFreqAndLevel",this.$el);this.$el.find(".after_save_message").removeClass("hidden");AMA.debug("Failed validation - location - frequency");AMA.debug("Failed validation - location - battery")}else{if(f.frequency===""){AMA.Util.switchLabel(".validation_text",".noFreq",this.$el);this.$el.find(".after_save_message").removeClass("hidden");AMA.debug("Failed validation - location - frequency")}else{if(f.batteryLevel===""){AMA.Util.switchLabel(".validation_text",".noBattLevel",this.$el);this.$el.find(".after_save_message").removeClass("hidden");AMA.debug("Failed validation - location - battery")}}}if(f.frequency===""||f.batteryLevel===""){k=true}}var j={};j.profileData=f;j.changes=i;j.settingsChanged=h;j.hasErrors=k;return j},saveSettings:function(d,c,e){if(c){this.data.models[0].set({locationEnabled:(d.locationCheck==="true"),frequencyMinutes:Number(d.frequency),batteryLevelThreshold:d.batteryLevel});AMA.debug("Location Settings sync data:"+JSON.stringify(this.data.models[0]));var b={url:AMA.models.locatesettings.url,success:e,callback:e,data:JSON.stringify(this.data.toJSON()[0])};this.data.sync("update",this.data.models[0],b)}},afterBackupSettingsSave:function(e,b,d,c){AMA.Util.switchLabel(".validation_text",".settingsSaved",this.$el);this.$el.find(".after_save_message").removeClass("hidden");AMA.models.endpointHistory.fetch();AMA.models.devicesettings.fetch()}})})();