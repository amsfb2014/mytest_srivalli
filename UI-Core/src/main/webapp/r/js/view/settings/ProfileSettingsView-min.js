/*! ProfilesettingsView */
(function(){AMA.namespace("view");var a=AMA.view.ProfileSettingsView=AMA.view.BaseView.extend();a.TEMPLATE_ID="profile_settings_template";a.TEMPLATE_SRC="";AMA.augment(a.prototype,{events:{"click .btnAccountInfoSave":"updateAccountInfo","click .btnChangePassword":"updatePassword","click .btnChangeSecurityInfo":"updateSecurityInfo","change select[name='securityquestion']":"clearSecurityAnswer","click #btnSubmitProfileSettings":"submitProfileSettings"},render:function(){a.__super__.render.apply(this,arguments);$("select[name='securityquestion']").val(AMA.Util.decodeHTMLEntityString(this.data.models[0].get("securityQuestion")))},_processData:function(b){name=b.phoneNumber;email=b.emailAddress;securityAnswer=b.securityAnswer},_afterRender:function(){a.__super__._afterRender.apply(this,arguments);this.parent.hideElements();this.parent.$el.find(".settings .connecting").hide();if(AMA.models.capabilities.canUpdate("accountSettings")){$("#account_info_submit").removeClass("hide");$("#password_submit").removeClass("hide");$("#securityQA_submit").removeClass("hide")}else{$("#account_info_submit").addClass("hide");$("#password_submit").addClass("hide");$("#securityQA_submit").addClass("hide")}},show:function(){a.__super__.show.apply(this,arguments)},updateAccountInfo:function(){var b=AMA.Util.decodeHTMLEntityString(this.data.models[0].get("emailAddress")),c=$.trim(this.$el.find("input[name='email']").get(0).value),e=true,d={},g=this,f=function(h){$("#account_info_submit .connecting").hide();if(typeof h=="object"&&h.error){AMA.Util.switchLabel(".validation_text",".email_taken",g.$el.find(".validation_accountinfo"));return}AMA.Util.switchLabel(".validation_text",".email_changed",g.$el.find(".validation_accountinfo"));AMA.page.logout()};if(c==""){AMA.Util.switchLabel(".validation_text",".email_empty",this.$el.find(".validation_accountinfo"));this.$el.find(".after_save_message").removeClass("hidden");e=false}else{if(!AMA.Util.validateEmail(c)){AMA.Util.switchLabel(".validation_text",".email_invalid",this.$el.find(".validation_accountinfo"));e=false}else{if(b===c){AMA.Util.switchLabel(".validation_text",".email_unchanged",this.$el.find(".validation_accountinfo"));e=false}}}if(!e){return}$("#account_info_submit .connecting").show();d.email=c;this.data.saveAccountInfo(d,f)},updatePassword:function(){var d=$.trim(this.$el.find("input[name='password']").get(0).value),g=$.trim(this.$el.find("input[name='newPin']").get(0).value),b=$.trim(this.$el.find("input[name='confirmPIN']").get(0).value),f=true,e=[],c=/^\s*[a-zA-Z0-9,\s]+\s*$/;if(d!==""||g!==""||b!==""){if(d===""){e.push(".current_password_empty");f=false}else{if(!c.test(d)){e.push(".current_password_has_special_chars");f=false}}if(g===""){e.push(".new_password_empty");f=false}else{if(this.validatePassword(g)){e.push(".new_password_length");f=false}else{if(!c.test(g)){e.push(".new_password_has_special_chars");f=false}}}if(b===""){e.push(".confirm_password_empty");f=false}if(b!==g){e.push(".confirm_password_mismatch");f=false}if(d!==""&&g!=""&&d===g){e.push(".password_unchanged");f=false}if(!f){AMA.Util.switchLabel(".validation_text",e,this.$el.find(".validation_password"));return}$("#password_submit .connecting").show();d=xssClean(d);g=xssClean(g);b=xssClean(b);this.encryptPassword(d,g,b)}},encryptPassword:function(c,g,b){var f=this,h=function(i){f._afterUpdatePassword(i)},e=function(m){if(!m){AMA.error("Expected response data is missing. Unable to perform password update");return}var i=m.secretKey,r=m.handle,o=m.initVector,q=CryptoJS.enc.Hex.parse(i),k=CryptoJS.enc.Hex.parse(o),j=CryptoJS.AES.encrypt(c,q,{iv:k}).toString(),l=CryptoJS.AES.encrypt(g,q,{iv:k}).toString(),n=CryptoJS.AES.encrypt(b,q,{iv:k}).toString(),p={oldPassword:j,newPassword:l,confirmPassword:n,secretHandle:r};f.data.saveNewPassword(p,h)},d=AMA.Util.getSecretPair(e)},_afterUpdatePassword:function(b){$("#password_submit .connecting").hide();if(typeof b=="object"&&b.error){if(b.error==="Invalid Password"){AMA.Util.switchLabel(".validation_text",".password_invalid",this.$el.find(".validation_password"))}else{AMA.Util.switchLabel(".validation_text",".password_update_error",this.$el.find(".validation_password"))}return}AMA.Util.switchLabel(".validation_text",".password_changed",this.$el.find(".validation_password"));AMA.page.logout()},updateSecurityInfo:function(){var b=AMA.Util.decodeHTMLEntityString(this.data.models[0].get("securityQuestion")),f=this.data.models[0].get("securityAnswer"),g=this.$el.find("select[name='securityquestion']").val(),c=$.trim(this.$el.find("input[name='securityanswer']").get(0).value),j=true,h={},d=this,e=function(){AMA.Util.switchLabel(".validation_text",".security_answer_changed",d.$el.find(".validation_securityqa"))},i=function(m,k){var l={callback:e};$("#securityQA_submit .connecting").hide();if(k===AMA.config.accountDetails.accountId){AMA.models.dashboardData.invalidate(l)}else{AMA.Util.switchLabel(".validation_text",".security_answer_update_error",d.$el.find(".validation_securityqa"))}};d.$el.find(".validation_securityqa .validation_text").hide();if(b!==g||(b===g&&f!==c&&c!=="")){if(c==""){AMA.Util.switchLabel(".validation_text",".security_answer_empty",this.$el.find(".validation_securityqa"));j=false}else{if(b===g&&f===c){AMA.Util.switchLabel(".validation_text",".security_answer_unchanged",this.$el.find(".validation_securityqa"));j=false}else{if(!this.validateSecurityAnswer(c)){AMA.Util.switchLabel(".validation_text",".security_answer_invalid",this.$el.find(".validation_securityqa"));j=false}}}if(!j){return}h.securityQuestion=g;h.securityAnswer=c;$("#securityQA_submit .connecting").show();this.data.saveSecurityQA(h,i)}},validateSecurityAnswer:function(b){return((b.length===4)&&!(isNaN(b)))},validatePassword:function(b){return(b.length<6||b.length>15)},clearSecurityAnswer:function(){AMA.Util.switchLabel(".validation_text","",this.$el.find(".validation_securityqa"));$("#profile_securityanswer").val("")},submitProfileSettings:function(){this.updateAccountInfo();this.updatePassword();this.updateSecurityInfo()}})})();