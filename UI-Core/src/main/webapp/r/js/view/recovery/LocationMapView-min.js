/*! LocationMapView */
(function(){AMA.namespace("view");var c=AMA.view.LocationMapView=AMA.view.BaseView.extend();c.TEMPLATE_ID="location_map_template";c.TEMPLATE_SRC="";var b={defaultZoom:3,markerZIndex:1000};var a="close_infobox";c.EVENT=AMA.enums("MAP_INITIALIZED");c.CurrentState=null;AMA.augment(c.prototype,{events:{"click .cancel_locate":"cancelLocation"},initialize:function(g){c.__super__.initialize.apply(this,arguments);this.options.viewOnly=g&&g.viewOnly||false;this.options.mapWidth=g&&g.mapWidth||AMA.config.locationPaneRWDMap.width;this.options.mapHeight=g&&g.mapHeight||AMA.config.locationPaneMap.height;this.lastMapWidth=this.options.mapWidth;this.lastMapHeight=this.options.mapHeight;this.CurrentState=null;if(!this.options.viewOnly){var k=this;this.parent.locationHistory.on(AMA.view.LocationHistoryListView.EVENT.ADDRESS_RETRIEVED,function(l){k.reset();if(k.data.get(l.id)){k._doRender()}});this.parent.locationHistory.bind(AMA.view.ListView.EVENT.LIST_EMPTIED,function(){k.reset();k.setData()});this.parent.locationHistory.on(AMA.view.ListView.EVENT.ITEM_SELECTED,function(m,l){k.status="";k.setData(m)});this.parent.on(AMA.view.BaseView.EVENT.SHOWN,function(){k._resizeMap()});var e=AMA.ActionManager,f=AMA.workflow.BaseWorkflow,h=AMA.workflow.LocateWorkflow,j=AMA.workflow.SecurePhoneWorkflow,i=e.getWorkflow("locate"),d=false;if(AMA.models.capabilities.canRead("deviceSecurePhoneAction")){d=e.getWorkflow("secure")}if(d){d.on(f.EVENT.STATE_CHANGED,function(l){switch(l.state){case f.STATE.INITIALIZING:break;case j.STATE.CONNECTING:c.CurrentState=j.STATE.CONNECTING;k.toggleState("connecting");k.$el.find("#location_progress_note .time_remaining").hide();k.$el.find("#location_progress_note .time_remaining .countdown").html("03:00");break;case j.STATE.REFINING:c.CurrentState=j.STATE.REFINING;AMA.debug("Contacts successfully erased; proceeding to next action");k.toggleState("refining");break;case f.STATE.FINALIZING:c.CurrentState=f.STATE.FINALIZING;k.toggleState("default");break;default:k.toggleState("default")}})}if(i){i.on(f.EVENT.STATE_CHANGED,function(l){switch(l.state){case h.STATE.CONNECTING:k.toggleState("connecting");break;case h.STATE.REFINING:k.toggleState("refining");break;case f.STATE.FINALIZING:k.status=(AMA.ActionManager.getWorkflow("locate")._result==AMA.workflow.BaseWorkflow.RESULT.FAILED)?"fail":"success";k.toggleState(k.status);break;default:}c.CurrentState=l.state;AMA.debug("Location Map View is now transitioning to '"+i.getStateName(l.state)+"' state")},this);i.on(f.EVENT.COUNTDOWN_TICK,function(l){k.$el.find("#location_progress_note .time_remaining").show();k.$el.find("#location_progress_note .time_remaining .countdown").html(l.remaining);k.infoboxLayer.clear()},this);i.on(f.EVENT.FINISHED,function(l){switch(l.result){case f.RESULT.SUCCESSFUL:break;case f.RESULT.FAILED:break;case f.RESULT.CANCELLED:k.$el.find("#message").hide();k.$el.find("#location_progress_note .time_remaining .countdown").html("03:00");break}AMA.debug("Location Map View finished with result of '"+i.getResultName(l.result)+"'")},this);if(e){e.on(e.EVENT.ACTION_STARTED,function(l){if(l.action==="locate"){k.infoboxLayer.clear()}})}}}},render:function(){if(this.pendingRender){return}if(!this.mapInitialized){if(!this.pendingRender){this.pendingRender=true;var e=this;this.once(c.EVENT.MAP_INITIALIZED,function(){e.pendingRender=false;e.render()});var g=(this.data&&this.data.length>0)?this.data.toJSON()[0]:{},j="";j=_.template(this.template,this._processData(g));this.$el.html(j);this._initMap()}return}if(!this.locationHistory){this.locationHistory={}}if(this.data&&this.data.length>0){this.$el.find("#bing_map_dialog").hide();this.$el.find("#message").hide();this.$el.find("#location_failed_note").hide();var f=this.data.models[0],l=true;if(!this.locationHistory[f.id]){this._prepareLocationData(f)}var i=this.locationHistory[f.id];this.pushpinLayer.clear();this.infoboxLayer.clear();this.pushpinLayer.push(i.marker);this.infoboxLayer.push(i.infobox);i.marker.setOptions({visible:true});switch(c.CurrentState){case AMA.workflow.LocateWorkflow.STATE.CONNECTING:case AMA.workflow.LocateWorkflow.STATE.REFINING:l=false;$("#accuracyinfoid").remove();$(".cancel_locate").hide();break;case AMA.workflow.SecurePhoneWorkflow.STATE.CONNECTING:case AMA.workflow.SecurePhoneWorkflow.STATE.REFINING:l=false;$("#accuracyinfoid").remove();break;default:break}i.infobox.setOptions({visible:l});this.$el.find("."+a).on("click",function(){i.infobox.setOptions({visible:false})});this.mapObject.setView({bounds:Microsoft.Maps.LocationRect.fromLocations(i.points)});this.mapObject.setView({zoom:this._getZoomBasedOnAccuracy(f.get("accuracy"))});this.$el.find("#accuracyinfoid").remove();var k=new Microsoft.Maps.Location(f.get("latitude"),f.get("longitude"));var d="<div id='accuracyinfoid' class='markerline accuracyInfo'> -- "+this._getAccuracy(f.get("accuracy"))+" "+AMA.config.accuracyUnit+" -- </div>";var h=new Microsoft.Maps.Pushpin(k,{htmlContent:d,zIndex:1000,visible:true});this.mapObject.entities.push(h);this._afterSetupMap.apply(this)}else{this._defaultMapView();this.$el.find("#location_failed_note").hide();if(this.$el.attr("id")!="dashboard_map"){if(this.status==="fail"){this.$el.find("#bing_map_dialog").hide();this.$el.find("#location_failed_note").show()}else{this.$el.find("#bing_map_dialog").show();this.$el.find("#message").show()}}}if(this.data&&this.data.length>0&&this.status=="fail"){if(this.$el.attr("id")!="dashboard_map"){this._defaultMapView();this.$el.find("#location_failed_note").show();this.$el.find("#bing_map_dialog").hide();this.$el.find("#message").hide()}}},reset:function(){this.locationHistory={}},refresh:function(){if(this.options.viewOnly){if(AMA.ActionManager.getWorkflow("locate")._state===AMA.workflow.LocateWorkflow.STATE.REFINING||AMA.ActionManager.getWorkflow("locate")._state===AMA.workflow.LocateWorkflow.STATE.CONNECTING){return}}c.__super__.refresh.apply(this)},_defaultMapView:function(){this.$el.find("#accuracyinfoid").remove();this.pushpinLayer.clear();this.infoboxLayer.clear();this.mapObject.setView({zoom:b.defaultZoom});this.mapObject.setView({bounds:Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(AMA.config.defaultMapCoordinates.lat,AMA.config.defaultMapCoordinates.lon))})},toggleState:function(d){switch(d){case"connecting":this._defaultMapView();this.$el.find("#message").hide();AMA.Util.switchLabel(".location_progress_text",".locating",this.$el);this.$el.find("#location_progress_note").show();this.$el.find("#location_progress_note .time_remaining").removeClass("hidden");this.$el.find("#location_failed_note").hide();this.$el.find("#location_progress_note .cancel_locate").show();break;case"refining":var e=this.data.toJSON()[0].accuracy||"0";AMA.Util.switchLabel(".location_progress_text",".refining",this.$el);this.$el.find("#location_progress_note .time_remaining").addClass("hidden");this.$el.find("#location_progress_note .cancel_locate").hide();break;case"fail":this._defaultMapView();this.$el.find("#location_progress_note").hide();this.$el.find("#location_failed_note").show();this.$el.find("#message").hide();break;case"success":this.$el.find("#location_progress_note").hide();this._doRender();this.render();break;default:this.$el.find("#location_progress_note").hide();this._doRender();this.render();break}},_prepareLocationData:function(e){var j=e.id;if(!this.locationHistory[j]){this.locationHistory[j]={}}var h=e.get("coordinates");this.locationHistory[j]["latLongObject"]=new Microsoft.Maps.Location(h.split(",")[0],h.split(",")[1]);var d=-1;for(var f=0;f<AMA.models.locations.models.length;f++){var e=AMA.models.locations.models[f];if(j==e.id){d=f;break}}var g=this._createAccuracyCircle(this.locationHistory[j]["latLongObject"],e.get("address"),this._locationFormat(e.get("time")),e.get("accuracy"),d+1,true);this.locationHistory[j]["marker"]=g.polygon;this.locationHistory[j]["points"]=g.points;this.locationHistory[j]["infobox"]=g.infobox},_setupEvents:function(){var d=this;Backbone.globalEvent.on("onLocate",function(f){d.status=f.status;d.render()})},_onPageResize:function(){this._resizeMap()},_afterSetupMap:function(){$("#refresh_loc_map").off("click").on("click",function(d){d.stopPropagation();d.preventDefault();AMA.ActionManager.start("locate");return false});this._resizeMap()},_initMap:function(){try{var d={credentials:AMA.config.getBingMapsKey(),center:new Microsoft.Maps.Location(AMA.config.defaultMapCoordinates.lat,AMA.config.defaultMapCoordinates.lon),mapTypeId:Microsoft.Maps.MapTypeId[AMA.config.defaultMapType],zoom:b.defaultZoom,showScalebar:false,enableClickableLogo:false,enableSearchLogo:false,width:this.options.mapWidth,height:this.options.mapHeight};if(this.options.viewOnly){_.extend(d,{disableUserInput:true,showDashboard:false})}this.mapObject=new Microsoft.Maps.Map(this.$el.find("#bing_map")[0],d);Microsoft.Maps.Events.addHandler(this.mapObject,"keydown",function(g){if(g.keyCode===40||g.keyCode===38){g.handled=true}});var f=this;this.mapObject.getCredentials(function(g){if(g===null){AMA.ReportingManager.remoteLog("Bing was unable to validate our key [accountID:-"+AMA.config.accountDetails.accountId+"][MDN:-"+AMA.config.accountDetails.accountMdn+"]",AMA.config.JsonConstants.LOGLEVEL_STATES.AUDIT)}else{f.pushpinLayer=new Microsoft.Maps.EntityCollection({zIndex:b.markerZIndex++});f.infoboxLayer=new Microsoft.Maps.EntityCollection({zIndex:b.markerZIndex++});f.mapObject.entities.push(f.pushpinLayer);if(!f.options.viewOnly){f.mapObject.entities.push(f.infoboxLayer)}f.mapInitialized=true;f.trigger(c.EVENT.MAP_INITIALIZED)}});Microsoft.Maps.Events.addThrottledHandler(this.mapObject,"viewchangeend",this.followMouse,500)}catch(e){return}this._resizeMap()},followMouse:function(){$("a").on("mouseout",function(d){$(".NavBar_modeSelectorControlContainer").find(".NavBar_itemContainer").each(function(e){$(this).attr("href","javascript:")})})},_createAccuracyCircle:function(l,h,y,s,p,q){var i=s;if(s.indexOf(",")!=-1){i=s.substring(0,s.indexOf(","))}if(i<10){i=10}var k=6371;var n=(l.latitude*Math.PI)/180;var g=(l.longitude*Math.PI)/180;var w=parseFloat(i/1000)/k;var v=[];for(x=0;x<=360;x++){var e={};brng=x*Math.PI/180;e.Latitude=Math.asin(Math.sin(n)*Math.cos(w)+Math.cos(n)*Math.sin(w)*Math.cos(brng));e.Longitude=((g+Math.atan2(Math.sin(brng)*Math.sin(w)*Math.cos(n),Math.cos(w)-Math.sin(n)*Math.sin(e.Latitude)))*180)/Math.PI;e.Latitude=(e.Latitude*180)/Math.PI;v.push(new Microsoft.Maps.Location(e.Latitude,e.Longitude))}try{var o={};var m={fillColor:new Microsoft.Maps.Color(AMA.config.mapAccuracyCirleColor[1][3],AMA.config.mapAccuracyCirleColor[1][0],AMA.config.mapAccuracyCirleColor[1][1],AMA.config.mapAccuracyCirleColor[1][2]),strokeColor:new Microsoft.Maps.Color(AMA.config.mapAccuracyCirleColor[2][3],AMA.config.mapAccuracyCirleColor[2][0],AMA.config.mapAccuracyCirleColor[2][1],AMA.config.mapAccuracyCirleColor[2][2]),strokeThickness:2,visible:false};var r=new Microsoft.Maps.Polygon(v,m);if(q){var t=this._createInfoBox(p);var u={htmlContent:t,visible:false};var f=new Microsoft.Maps.Infobox(l,u);o.infobox=f}o.polygon=r;o.points=v;o.infobox=f;return o}catch(j){return null}},_locationFormat:function(e){if(e!=null&&e!=""){var d=new Date(e);return AMA.Util.formatDateAndTime(d,AMA.config.dateAndTimeFormat)}},_getAccuracy:function(d){switch(AMA.config.accuracyUnit){case"yards":return Math.floor(AMA.Util.metersToYards(d));break;case"meters":case"miles":default:return Math.floor(d);break}},_createInfoBox:function(d){if(!this.infoboxTemplate){this.infoboxTemplate=$("#location_map_infobox_template").html()}var e=this.data.toJSON()[0];e.index=d-1;e.locatedClass="";e.historyClass="show";if(d==1){e.locatedClass="show";e.historyClass=""}e.timeLocated=this._locationFormat(e.eventTime);if(!e.address){e.address=""}e.infoboxElClass=a;e.accuracy=this._getAccuracy(e.accuracy);return _.template(this.infoboxTemplate,e)},cancelLocation:function(d){d.stopPropagation();var f=AMA.ActionManager.getWorkflow("locate");f.cancelLocate();this._defaultMapView();this.$el.find("#location_failed_note").show();this.$el.find("#bing_map_dialog").hide();this.$el.find("#message").hide();this.$el.find("#location_progress_note").hide()},_getZoomBasedOnAccuracy:function(d){var e=parseInt(d);if(e<20){return 19}else{if(e<60){return 18}else{if(e<120){return 17}else{if(e<250){return 16}else{if(e<500){return 15}else{if(e<1000){return 14}else{if(e<2000){return 13}else{if(e<4000){return 12}else{if(e<7000){return 11}else{if(e<15000){return 10}else{if(e<28000){return 9}else{if(e<60000){return 8}else{if(e<130000){return 7}else{if(e<250000){return 6}else{if(e<500000){return 5}else{if(e<1000000){return 4}else{return 3}}}}}}}}}}}}}}}}},_resizeMap:function(){var i=$("#bing_map"),e=$("#map_container"),n=e.parent(),k=$("#bing_map_dialog"),l=$("#location_right .note"),d=$("#locate_toolset").outerHeight(),f=parseInt($("#header_link").css("padding-top")),h=d+f,j=parseInt($("#location-toggle-submenu").css("height")),g=document.documentElement.clientHeight,o=parseInt(e.css("min-height")),m=g-h-j;m=o>m?o:m;if(!$("#page_content").hasClass("hidden")){this.lastMapWidth=n.width();this.lastMapHeight=n.height()-l.outerHeight()}if($(window).width()>767){i.width(this.lastMapWidth-((parseInt(i.css("border-width")))*2)).height(this.lastMapHeight-((parseInt(i.css("border-width")))*2));k.width(this.lastMapWidth).height(this.lastMapHeight);i.find(".MicrosoftMap").width(this.lastMapWidth).height(this.lastMapHeight);this.mapObject.setOptions({width:this.lastMapWidth,height:this.lastMapHeight})}else{i.css({width:"100%",height:m+"px"});k.css({width:"100%",height:m+"px"});i.find(".MicrosoftMap").css({width:"100%",height:m+"px"})}}})})();