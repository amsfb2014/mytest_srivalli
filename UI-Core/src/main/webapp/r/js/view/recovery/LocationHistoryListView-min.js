/*! LocationHistoryListView */
(function(){AMA.namespace("view");var a=AMA.view.LocationHistoryListView=AMA.view.ListView.extend();a.TEMPLATE_ID="location_history_item_template";a.TEMPLATE_SRC="";a.CSS={ITEM:"item",ITEM_STYLE:["rt_rowlighter","rt_rowdarker"],SELECTED_ITEM:"selected"};a.EVENT=AMA.enums("ADDRESS_RETRIEVED");AMA.augment(a.prototype,{events:{"click #clear_location_history a.link_text":"clearLocationHistory","click .address a.link_text":"locate","click  #button_locate_history_normal":"locate"},lastRecordedLocation:null,initialize:function(){a.__super__.initialize.apply(this,arguments);this.responsiveListContainer=$("#location-menu-tab-sm-full .menu");if(!this.lastlocationSubmenuTemplate){this.lastlocationSubmenuTemplate=$("#last_location_submenu_item_template").html()}if(!this.previouslocationSubmenuTemplate){this.previouslocationSubmenuTemplate=$("#previous_location_submenu_item_template").html()}var h=this;this.bind(a.EVENT.ADDRESS_RETRIEVED,function(i){h.$el.find("[uid="+i.get("id")+"] .address").html(i.get("address"));h.responsiveListContainer.find("[uid="+i.get("id")+"] .address").html(i.get("address"))});this.bind(AMA.view.ListView.EVENT.LIST_EMPTIED,function(){var i={id:0,elId:"location_history_0",elStyle:"",timeLocated:"",accuracy:""};h.$el.find("#location_last").html(_.template(h.template,i));h.$el.find("#location_history_1_to_4").html("");h.$el.find("#location_previous").toggle(this.data.models.length>1);h.$el.find("#clear_location_history").hide();h.responsiveListContainer.html(_.template(h.lastlocationSubmenuTemplate,i))});var c=AMA.ActionManager,d=AMA.workflow.BaseWorkflow,e=AMA.workflow.LocateWorkflow,g=AMA.workflow.SecurePhoneWorkflow,f=c.getWorkflow("locate"),b=false;if(AMA.models.capabilities.canRead("deviceSecurePhoneAction")){b=c.getWorkflow("secure")}if(f){f.on(d.EVENT.STATE_CHANGED,function(i){switch(i.state){case e.STATE.CONNECTING:h.toggleStateDisplay("connecting");h.selectLocationSubmenuItem();break;case e.STATE.REFINING:h.toggleStateDisplay("refining");break;case d.STATE.FINALIZING:h.toggleStateDisplay((f._result==AMA.workflow.BaseWorkflow.RESULT.FAILED)?"fail":"success");break;default:}AMA.debug("Location History List View is now transitioning to '"+f.getStateName(i.state)+"' state")},this);f.on(d.EVENT.FINISHED,function(i){switch(i.result){case d.RESULT.CANCELLED:h.toggleStateDisplay("cancelled");break}},this)}if(b){b.on(d.EVENT.STATE_CHANGED,function(i){switch(i.state){case g.STATE.CONNECTING:h.selectLocationSubmenuItem();h.toggleStateDisplay("connecting");break;case g.STATE.REFINING:h.toggleStateDisplay("refining");break;case d.STATE.FINALIZING:h.toggleStateDisplay("default");break;default:h.toggleStateDisplay("default")}AMA.debug("Location History List View is now transitioning to '"+b.getStateName(i.state)+"' state")},this)}if(!AMA.models.capabilities.canRead("eventSettings")){h.$el.siblings(".location_settings").children().hide()}else{if(AMA.models.capabilities.canUpdate("eventSettings")){h.$el.siblings(".location_settings").children(".link:not(:has(.Edit_Location_Settings))").hide()}else{if(AMA.models.capabilities.canRead("eventSettings")&&!AMA.models.capabilities.canUpdate("eventSettings")){h.$el.siblings(".location_settings").children(".link:not(:has(.View_Location_Settings))").hide()}}}},_setupEvents:function(){AMA.debug("List view "+this.options.el+" is initializing onclick handler for each item");var b=this;if(this.data&&this.data.models.length>0){this.$el.find("."+b._css.ITEM).on("click",function(){if(!$(this).closest(".location_refining").size()&&!$(this).closest(".location_connecting").size()){AMA.debug("User clicked item #"+$(this).attr("id")+" on list view "+b.options.el);b._selectItem(this)}});$("#location-menu-tab-sm-full li").on("click",function(){if(b.data.models.length>0){var c=$(this).attr("uid");b.selectLocationSubmenuItem(c);b._selectItem(b.$el.find("[uid="+c+"] ."+b._css.ITEM)[0])}})}$("#submenu-locate-refresh").on("click",function(){b.locate()})},toggleStateDisplay:function(c){var b={connecting:".location_connecting",refining:".location_refining","default":".default",success:".default",fail:".default",cancelled:".default"};this.$el.find(b[c]).show().siblings(".location_history").hide();$("#location-toggle-submenu").removeClass("connecting refining").addClass(c);switch(c){case"connecting":AMA.debug("Location History List View is now transitioning to 'connecting' state");break;case"refining":AMA.debug("Location History List View is now transitioning to 'refining' state");break;case"fail":AMA.debug("Location History List View is now transitioning to 'failing' state");this._selectItem();break;case"success":AMA.debug("Location History List View is now transitioning to 'success' state");break;case"cancelled":AMA.debug("Location History List View is now transitioning to 'cancelled' state");this.$el.find(".location_history").hide();this.$el.find(".default").show();break;default:}},render:function(){var g="",d="";firstLoc=null,oldLocation=false;this._applyFilters();AMA.debug(this.options.el+" has a final dataset of "+this._dataset.length+" items");this.data.prepareLocations();this.data.clearDuplicateLocations();this.responsiveListContainer.empty();if(this.data.length>0){var c=this.data.toJSON();for(var f=0;f<this.data.numberOfPoints;f++){var b=c[f];if(b){processedData=this._processData(b,f);templatedContent=_.template(this.template,processedData);g+=templatedContent;d=templatedContent;d=d.replace("id","class");if(f==0){this.$el.find("#location_last").html(g);this.responsiveListContainer.append(_.template(this.lastlocationSubmenuTemplate,processedData));g=""}else{this.responsiveListContainer.append(_.template(this.previouslocationSubmenuTemplate,processedData))}}}}else{this.$el.find("#location_last").html("");this.responsiveListContainer.empty()}this.$el.find("#location_history_1_to_4").html(g);this.$el.find("#location_previous").toggle(this.data.models.length>1);this.$el.find("#clear_location_history").show();this._items=this.$el.find(".default ."+this._css.ITEM);AMA.debug(this.options.el+" has rendered "+this._items.length+" items");firstLoc=(this.data.models.length>0)?this.data.models[0]:null,oldLocation=(firstLoc&&this.lastRecordedLocation&&firstLoc.attributes.eventTime<=this.lastRecordedLocation.attributes.eventTime)?true:false;if(oldLocation===true){AMA.debug("Exiting render of location history. Not updated location.");return}this.lastRecordedLocation=firstLoc;AMA.debug("Saving the last recorded location",this.lastRecordedLocation);if(this._items.length>0){var e=this.selectedItem&&this.$el.find("[uid='"+$(this.selectedItem).attr("uid")+"']")||[],h=e.length>0;this._selectItem(h?e[0]:this._items[0]);AMA.debug("Previously selected item is still in list: "+h)}else{this.trigger(AMA.view.ListView.EVENT.LIST_EMPTIED);AMA.debug(this.options.el+" has triggered a 'list emptied' event.");this._selectItem()}},clearLocationHistory:function(){var c=this;var b=$("#msg_confirm_clear_location_history").html();AMA.page.standardDialogs.confirm(b,function(){d=d||$("#msg_confirm_clear_location_history").html();var d=c.$el.find(".msg_loadingdialog").html();AMA.page.standardDialogs.loading(d);c.data.sync("delete",c.data,{parse:function(){},success:function(){c.data.fetch();AMA.page.standardDialogs.hideloading()},error:function(){c.data.fetch();AMA.page.standardDialogs.hideloading()}});setTimeout(function(){},500)})},locate:function(){AMA.ActionManager.start("locate")},_afterRender:function(){for(var d=0;d<this.data.numberOfPoints;d++){var b=this.data.models[d];if(!b.get("address")){var e="https://dev.virtualearth.net/REST/v1/Locations/"+b.get("coordinates");var g={output:"json",key:AMA.config.getBingMapsKey()};var f=this;var c=function(l,j,i,m){var k=this.data.models[l];if(j&&j.resourceSets&&j.resourceSets.length>0&&j.resourceSets[0].resources&&j.resourceSets[0].resources.length>0){var h=f._getAddress(j.resourceSets[0].resources[0]);k.set("address",h,{silent:true});this.trigger(a.EVENT.ADDRESS_RETRIEVED,k)}else{AMA.debug("Bing was unable to find an address for location: "+k.get("coordinates"));AMA.ReportingManager.remoteLog("Bing was unable to find an address for location: "+k.get("coordinates"),AMA.config.JsonConstants.LOGLEVEL_STATES.AUDIT)}};$.getJSON(e+"?jsonp=?",g,_.bind(c,this,d))}}},_selectItem:function(c){var d,b;if(this.selectedItem){$(this.selectedItem).parent().removeClass(this._css.SELECTED_ITEM);this.responsiveListContainer.find("li").removeClass("selected")}this.selectedItem=c;if(this.selectedItem){d=$(this.selectedItem);d.parent().addClass(this._css.SELECTED_ITEM);AMA.debug("Item #"+d.parent().attr("id")+" has been selected on list view "+this.options.el);b=d.parent().attr("uid");this.selectLocationSubmenuItem(b);this.trigger(AMA.view.ListView.EVENT.ITEM_SELECTED,this.data.get(b));AMA.debug(this.options.el+" has triggered an 'item selected' event with uid="+b)}else{this.trigger(AMA.view.ListView.EVENT.SELECTION_CLEARED);this.selectLocationSubmenuItem();AMA.debug("There is no selected item on list view "+this.options.el+"; a 'selection cleared' event has been triggered")}},_processData:function(c,b){c.elId="location_history_"+b;c.elStyle="";c.address=c.address||"";c.timeLocated=this._locationFormat(c.time,c.eventTimeTo);switch(AMA.config.accuracyUnit){case"meters":c.accuracy=Math.floor(c.accuracy);break;case"yards":c.accuracy=Math.floor(AMA.Util.metersToYards(c.accuracy));break;case"miles":c.accuracy=Math.floor(c.accuracy);break;default:c.accuracy=Math.floor(c.accuracy);break}return c},_locationFormat:function(d,b){if(d!=null&&d!=""){var c=new Date(d);if(b!=null){var e=new Date(b);if(c.getDate()==e.getDate()){if(c.getHours()==e.getHours()&&c.getMinutes()==e.getMinutes()){return(AMA.Util.isIPhone()===true)?$.timeago(c):AMA.Util.formatDateAndTime(c,AMA.config.dateAndTimeFormat)}}return(AMA.Util.isIPhone()===true)?$.timeago(e):(AMA.Util.formatDateAndTime(c,AMA.config.dateAndTimeFormat)+" - "+AMA.Util.formatDateAndTime(e,AMA.config.dateAndTimeFormat))}return(AMA.Util.isIPhone()===true)?$.timeago(c):AMA.Util.formatDateAndTime(c,AMA.config.dateAndTimeFormat)}},_getAddress:function(c){var b="";b+=c.address.locality!=null?c.address.locality:"";b+=c.address.adminDistrict!=null?(b!=""?", ":"")+c.address.adminDistrict+" ":"";b+=c.address.postalCode!=null?(b!=""?" ":"")+c.address.postalCode:"";AMA.debug("getAddress: "+b);return b},selectLocationSubmenuItem:function(c){this.responsiveListContainer.children().removeClass("selected");if(c){this.responsiveListContainer.find("[uid="+c+"]").addClass("selected")}c=c||0;var b=this.responsiveListContainer.find("[uid="+c+"] .submenuItemLabel").text();$("#location-toggle-submenu .submenu-title").text(b)}})})();